<html>
<head>
    <link rel="stylesheet" type="text/css" href="gOl.css">
    <script src="jquery-1.8.2.js" type="text/javascript"></script>
    <script src="pathFinding.js" type="text/javascript"></script>
    <script src="underscoreJS/underscore-min.js"></script>
    <title>sayWhat ?</title>
</head>
<body oncontextmenu="return false;">
    <div class="rainCoat">
        <div class="form">
            <div class="row">
                <label for="display-width">GridWidth</label>
                <input type="text" class="gridWidth"/>
            </div>
            <!--<div class="row">
                <label for="display-Height">GridHeight</label>
                <input type="text" class="gridHeight"/>
            </div>-->
            <div class="row">
                <div class="customButton createGrid">Create Grid</div>
            </div>
            <div class="row">
                <div class="customButton demoButton">Demo</div>
            </div>
            <div class="row">
                <div class="customButton startGame">Start</div>
            </div>
        </div>
        <div class="frame"></div>
    </div>
	
    <script type="text/javascript">
        var tiles = {};
        jQuery(document).ready(function () {
            /*tile properties*/
            var gridHeigth, strtCoorX, strtCoorY, endCoorX, endCoorY, gridWidth;
            var start = 1
            var newStart = [];
            checkedNeighbours = [];
            
            $('.demoButton').click(function () {
                $('.gridWidth').val('40');
                $('.createGrid').click();
                tiles['3|5'].visibleTile.className += ' rock';
                tiles['4|5'].visibleTile.className += ' rock';
                tiles['5|5'].visibleTile.className += ' rock';
                tiles['6|5'].visibleTile.className += ' rock';
                tiles['7|5'].visibleTile.className += ' rock';
                tiles['8|5'].visibleTile.className += ' rock';
                tiles['9|5'].visibleTile.className += ' rock';
                tiles['9|6'].visibleTile.className += ' rock';
                tiles['9|7'].visibleTile.className += ' rock';
                tiles['9|8'].visibleTile.className += ' rock';
                tiles['9|9'].visibleTile.className += ' rock';
                tiles['9|10'].visibleTile.className += ' rock';
                tiles['9|11'].visibleTile.className += ' rock';
                tiles['9|12'].visibleTile.className += ' rock';
                tiles['9|13'].visibleTile.className += ' rock';
                tiles['9|14'].visibleTile.className += ' rock';
                tiles['9|15'].visibleTile.className += ' rock';
                tiles['9|16'].visibleTile.className += ' rock';
                tiles['9|17'].visibleTile.className += ' rock';
                tiles['3|18'].visibleTile.className += ' rock';
                tiles['4|18'].visibleTile.className += ' rock';
                tiles['5|18'].visibleTile.className += ' rock';
                tiles['6|18'].visibleTile.className += ' rock';
                tiles['7|18'].visibleTile.className += ' rock';
                tiles['8|18'].visibleTile.className += ' rock';
                tiles['9|18'].visibleTile.className += ' rock';
            });

            /*NodeObjectConstructor with necessary properties and parameters.*/
            NodeObject = function (x, y, type, visited) {
                this.h = function () {
                    return this.g + this.f;
                }
                this.g;
                this.f;
                this.fieldType;
                this.x = x;
                this.y = y;
                this.paraneNodeX;
                this.parentNodeY;
                this.type = type;
                this.visited = 0;
                this.closed = false;
            };
            /*drawing rocks via rightclick*/
            $('body').on('mousedown', '.frame div', function (e) {
                if (e.which === 3) {
                    $(this).toggleClass('rock');
                }
            });
            $('body').on('click', '.frame div', function (e) {
                /*captureing coordinates for start and endpoint*/
                var $this = $(this);
                var $xClicked = $this.data('xco');
                var $yClicked = $this.data('yco');
                if (!$this.hasClass('rock')) {
                    if (start == 1) {
                        tiles[($xClicked) + '|' + ($yClicked)].visibleTile.className += ' start';
                        strtCoorX = $this.data('xco');
                        strtCoorY = $this.data('yco');
                        tiles[$xClicked+'|'+$yClicked].closed=true;
                        start++;
                    } else if (start == 2) {
                        tiles[($xClicked) + '|' + ($yClicked)].visibleTile.className += ' end';
                        endCoorX = $this.data('xco');
                        endCoorY = $this.data('yco');
                        tiles[$xClicked + '|' + $yClicked].closed = true;
                        start++;
                    }
                }
            });


            /*Grid Initialisation \ starting a new generation*/
            $('.createGrid').click(function () {
                /*Destroying the previously used NodeObjects and stateCarrier to prepare for the next generation*/
                tiles = {};
                checkedNeighbours = [];
                start = 1;
                strtCoorX = null;
                strtCoorY = null;
                endCoorX = null;
                endCoorY = null;
                $('.frame').empty();

                /*parsing input*/
                gridWidth = parseInt($('.gridWidth').val());
                gridHeigth = gridWidth;
                

                $('.frame').css('width', gridWidth * 8);
                

                /*recursive creating of the NodeObjects*/
                for (var x = 0; x < gridWidth; x++) {
                    
                    for (var y = 0; y < gridHeigth; y++) {
                        var kind = 'plains';
                        /*different kinds of tiles to be implemented along with the heuristic*/
                        //var prob = Math.floor((Math.random() * 10) + 1);
                        //if (prob <= 7) { kind = 'plains'; };
                        //if (prob > 7) { kind = 'rock plains'; };
                        //if (prob === 10) { kind = 'wall plains' };
                        
                        tiles[x + "|" + y] = new NodeObject(x, y, kind);
                    }
                }

                var f = $('.frame').get(0);
                for (var properties in tiles) { 
                    var currentTile = tiles[properties];

                    currentTile.visibleTile = document.createElement('div');
                    currentTile.visibleTile.setAttribute('data-xco', currentTile.x);
                    currentTile.visibleTile.setAttribute('data-yco', currentTile.y);
                    currentTile.visibleTile.className = currentTile.type;

                    f.appendChild(currentTile.visibleTile);
                }
            });

            $('.startGame').click(function () {

                var d1 = new Date();
                var endGame = false;
                var currentPlateX = strtCoorX;
                var currentPlateY = strtCoorY;
                var visitedTiles = {};

                while (!endGame) {
                    var distanceComparison = 4294967295;
                    var newStart = [];
                    var distances = [];
                    var visa = [];
                    var mod, curX, curY, endX, endY, id;
                    endX = endCoorX;
                    endY = endCoorY;

                    /*function for finding neighbours*/

                    function check(newStart, curX, curY) {
                        id = curX + '|' + curY
                        if (tiles[id] !== undefined && !tiles[id].visibleTile.classList.contains('rock')) {
                            if (tiles[id].visited < 1) {
                                tiles[id].visibleTile.distanceToTarget = Math.pow(Math.abs(curX - endX), 2) + Math.pow(Math.abs(curY - endY), 2);
                                newStart.push(tiles[id].visibleTile);
                                distances.push(tiles[id].visibleTile.distanceToTarget);
                                tiles[id].closed = true;
                            }
                        }
                        return newStart;
                    }
                    /*finding all 8 neighbours of the current waypoint*/
                    newStart = check(newStart, currentPlateX - 1, currentPlateY - 1);
                    newStart = check(newStart, currentPlateX, currentPlateY - 1);
                    newStart = check(newStart, currentPlateX + 1, currentPlateY - 1);
                    newStart = check(newStart, currentPlateX - 1, currentPlateY);
                    newStart = check(newStart, currentPlateX + 1, currentPlateY);
                    newStart = check(newStart, currentPlateX - 1, currentPlateY + 1);
                    newStart = check(newStart, currentPlateX, currentPlateY + 1);
                    newStart = check(newStart, currentPlateX + 1, currentPlateY + 1);

                    if (newStart.length == 0) {
                        alert('1234');
                        return;
                    }

                    var newStartTile = null;

                    /*finding the closest tile to the target*/
                    //checkedNeighbours = _.sortBy(distances, function (num) {
                    //    return num;
                    //});
                    
                    for (var i = 0; i < newStart.length; i++) {
                        if (newStart[i].distanceToTarget < distanceComparison) {
                            newStartTile = newStart[i];
                            distanceComparison = newStart[i].distanceToTarget;
                        }
                    }

                    for (var i = 0; i < newStart.length; i++) {
                        if (newStart[i].distanceToTarget == checkedNeighbours[0]) {
                            newStartTile = newStart[i];
                        }
                    }
                    newStartTile.className += ' marker';
                    
                    /*setting up the new waypoint*/
                    currentPlateX = parseInt(newStartTile.dataset['xco']);
                    currentPlateY = parseInt(newStartTile.dataset['yco']);

                    visitedTiles[currentPlateX + '|' + currentPlateY] = newStartTile;
                    if (tiles[currentPlateX + '|' + currentPlateY].visited < 8) {
                        tiles[currentPlateX + '|' + currentPlateY].visited += 1;
                    }
                    /*condition for finishing the loop*/
                    if (currentPlateX === endCoorX && currentPlateY === endCoorY) {
                        endGame = true;
                        //console.log(visitedTiles);
                        //for (props in visitedTiles) {
                        //    var currentTile = visitedTiles[props];
                        //    currentTile.className += ' marker';
                        //}
                    }
                }
                console.log(new Date - d1);

            })
        });
    </script>
</body>
</html>
